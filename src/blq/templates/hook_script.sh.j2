#!/bin/sh
# .lq/hooks/{{ command_name }}.sh
# Generated by blq v{{ blq_version }} - regenerate with: blq hooks generate {{ command_name }}
# Checksum: {{ checksum }}
#
# Command: {{ command_name }}
{% if template %}
# Template: {{ template }}
{% else %}
# Command: {{ cmd }}
{% endif %}
{% if defaults %}
# Defaults: {{ defaults_str }}
{% endif %}
# Generated: {{ generated_at }}

set -e

# === Embedded Command Info ===
BLQ_COMMAND="{{ command_name }}"
{% if template %}
BLQ_TEMPLATE="{{ template }}"
{% else %}
BLQ_CMD="{{ cmd }}"
{% endif %}
BLQ_SCRIPT_VERSION="1"
BLQ_CHECKSUM="{{ checksum }}"

{% for key, value in defaults.items() %}
BLQ_DEFAULTS_{{ key }}="{{ value }}"
{% endfor %}

# === Parse Arguments ===
VIA="${BLQ_VIA:-auto}"
METADATA="${BLQ_METADATA:-auto}"
DRY_RUN=0
PARAMS=""

while [ $# -gt 0 ]; do
    case "$1" in
        --via=*) VIA="${1#--via=}" ;;
        --metadata=*) METADATA="${1#--metadata=}" ;;
        --dry-run) DRY_RUN=1 ;;
        --help|-h)
            echo "Usage: {{ command_name }}.sh [OPTIONS] [PARAMS...]"
            echo ""
            echo "Options:"
            echo "  --via=MODE        Execution mode: blq, standalone, auto (default: auto)"
            echo "  --metadata=FMT    Output metadata: auto, none, json, header, footer, FILE"
            echo "  --dry-run         Print command without executing"
            echo "  --help            Show this help"
            echo ""
            echo "Parameters:"
{% for key, value in defaults.items() %}
            echo "  {{ key }}=VALUE     (default: {{ value }})"
{% endfor %}
            exit 0
            ;;
        *=*) PARAMS="$PARAMS $1" ;;
        *) echo "Unknown argument: $1" >&2; exit 1 ;;
    esac
    shift
done

# === Resolve Execution Mode ===
if [ "$VIA" = "auto" ]; then
    if command -v blq >/dev/null 2>&1; then
        VIA="blq"
    else
        VIA="standalone"
    fi
fi

# === Resolve Metadata Mode ===
# auto: none when via=blq (blq captures everything), footer when standalone
if [ "$METADATA" = "auto" ]; then
    if [ "$VIA" = "blq" ]; then
        METADATA="none"
    else
        METADATA="footer"
    fi
fi

# === Resolve Parameters ===
# Apply defaults, then override with provided params
{% for key, value in defaults.items() %}
{{ key }}="${BLQ_DEFAULTS_{{ key }}}"
{% endfor %}

for param in $PARAMS; do
    key="${param%%=*}"
    value="${param#*=}"
    eval "${key}=\"${value}\""
done

# === Build Commands ===
{% if template %}
# Render template with resolved parameters
STANDALONE_CMD="{{ standalone_cmd_template }}"
BLQ_CMD="blq run {{ command_name }}{% for key in defaults.keys() %} {{ key }}=\${{"{"}}{{ key }}{{"}"}}{% endfor %}"
{% else %}
STANDALONE_CMD="{{ cmd }}"
BLQ_CMD="blq run {{ command_name }}"
{% endif %}

# === Select Command ===
if [ "$VIA" = "blq" ]; then
    CMD="$BLQ_CMD"
else
    CMD="$STANDALONE_CMD"
fi

# === Dry Run ===
if [ "$DRY_RUN" = "1" ]; then
    echo "$CMD"
    exit 0
fi

# === Metadata Helpers ===
build_metadata() {
    exit_code="${1:-null}"
    git_sha="$(git rev-parse HEAD 2>/dev/null || echo '')"
    timestamp="$(date -u +%Y-%m-%dT%H:%M:%SZ)"
{% if defaults %}
    params_json="{% raw %}{{% endraw %}{% for key in defaults.keys() %}\"{{ key }}\":\"\${{"{"}}{{ key }}{{"}"}}\"{% if not loop.last %},{% endif %}{% endfor %}{% raw %}}{% endraw %}"
{% else %}
    params_json="{}"
{% endif %}
    echo "{\"command\":\"$BLQ_COMMAND\",\"via\":\"$VIA\",\"params\":$params_json,\"exit_code\":$exit_code,\"git_sha\":\"$git_sha\",\"timestamp\":\"$timestamp\"}"
}

emit_metadata_pre() {
    case "$METADATA" in
        none) ;;
        json) build_metadata ;;
        header) echo "# blq:meta $(build_metadata)" ;;
        footer) ;; # after execution
        *) build_metadata > "$METADATA" ;;  # write to file
    esac
}

emit_metadata_post() {
    case "$METADATA" in
        footer) echo "# blq:meta $(build_metadata $1)" ;;
        *) ;;  # already handled or none
    esac
}

# === Execute ===
emit_metadata_pre

set +e
eval "$CMD"
EXIT_CODE=$?
set -e

emit_metadata_post $EXIT_CODE
exit $EXIT_CODE
